set -g allow-passthrough all
set -g mouse on
set-option -ga terminal-overrides ",xterm-256color:Tc"

set -g base-index 1
set-option -g status-position bottom
set-option -g status-justify centre
set-option -g automatic-rename on
set-option -g renumber-windows on

setw -g pane-base-index 1
setw -g pane-border-indicators arrows
setw -g pane-border-lines heavy
set -g pane-border-style "fg=#44475a"
set -g pane-active-border-style "fg=#bd93f9"
set -g display-panes-active-colour "#bd93f9"
set -g display-panes-colour "#6272a4"

unbind C-b
run-shell '
case "$(uname)" in
  Darwin)
    tmux set -g prefix M-space \; bind M-space send-prefix
    ;;
  Linux)
    if command -v wsl.exe >/dev/null 2>&1; then
      # needs to be remapped using e.g. PowerToys, M-space is OS specific
      tmux set -g prefix M-= \; bind M-= send-prefix
    else
      tmux set -g prefix M-space \; bind M-space send-prefix
    fi
    ;;
esac
'

unbind c
bind n new-window -c "#{pane_current_path}"
bind N command-prompt -p "New session name:" "\
  run-shell 'tmux new-session -Ad -s %1 -c \"#{pane_current_path}\"; \
             tmux switch-client -t %1'"
unbind &
bind x confirm-before -p "Kill window #W? (y/n)" kill-window
bind X confirm-before -p "Kill session #S? (y/n)" "\
  run-shell '\
    CURRENT_SESSION=\$(tmux display-message -p \"#S\"); \
    if [ \$(tmux list-sessions | wc -l) -eq 1 ]; then \
      tmux new-session -d -s main; \
      tmux switch-client -t main; \
    else \
      tmux switch-client -l 2>/dev/null || \
      tmux switch-client -t \$(tmux list-sessions -F \"#{session_name}\" | \
                               grep -v \"^\$CURRENT_SESSION\$\" | \
                               head -1); \
    fi; \
    tmux kill-session -t \"\$CURRENT_SESSION\"'"
unbind ,
bind r command-prompt "rename-window %%"
bind R command-prompt "rename-session %%"
unbind l
bind ` last-window
bind \~ switch-client -l

bind c display-popup -E -w90% -h90% -d "#{pane_current_path}" "opencode"
bind f display-popup -E "\
  sh -c 'tmux capture-pane -pS -10000 | \
         pathpicker | \
         fzf --prompt \"Path> \" | \
         xargs -r -I{} tmux new-window \"vim {}\"'"
bind g display-popup -E -w90% -h90% -d "#{pane_current_path}" "lazygit"
bind k display-popup -E -w90% -h90% "k9s"
bind m display-popup -E -w90% -h90% "\
  man -k . | \
  fzf --prompt \"Manual> \" --preview 'man {1}' \
      --preview-window=right:66% | \
  cut -d' ' -f1 | \
  xargs man"
bind ! display-popup -E "\
  ps -eo pid,user:15,comm --no-headers | \
  fzf --prompt \"Process> \" -m \
    --header 'Select processes to kill (TAB for multi-select)' \
    --preview 'echo \"=== Process Details ===\"; \
               ps -p {1} -o pid,ppid,user,cpu,pmem,rss,vsz,etime,cmd 2>/dev/null; \
               echo; \
               echo \"=== Process Tree ===\"; \
               pstree {1} -g 3 2>/dev/null || echo \"No tree available\"; \
               echo; \
               echo \"=== Network ===\"; \
               ss -tulpn 2>/dev/null | grep {1} | head -3 || echo \"No connections\"; \
               echo; \
               echo \"=== Working Dir ===\"; \
               pwdx {1} 2>/dev/null || echo \"Unknown\"' \
    --preview-window=right:66% | \
  awk '{print \$1}' | \
  xargs -r kill"
bind $ display-popup -E -w90% -h90% "zsh"
bind t display-popup -E -w90% -h90% "htop"
bind l display-popup -E "\
  sh -c 'tmux capture-pane -pS -10000 | \
         urlpicker | \
         fzf --prompt \"URL> \" | \
         xargs -r xdg-open'"
bind w display-popup -w76 -h45 "\
  curl -sS https://v2n.wttr.in/ 2>/dev/null | \
  awk 'NR > 2 {print prev2} {prev2=prev1; prev1=\$0}'"
bind Tab display-popup -E -w80 -h20 "\
  CURRENT_SESSION=\$(tmux display-message -p '#{session_name}'); \
  { echo \"\$CURRENT_SESSION\"; tmux list-sessions -F '#{session_name}' | grep -v \"^\$CURRENT_SESSION\$\"; } | \
  fzf --prompt 'Session> ' --preview '\
    tmux list-windows -t {} -F \"#{window_index}: #{window_name}#{?window_active, (active),}\" | \
    while read -r win; do \
      echo \"  \$win\"; \
      tmux list-panes -t {}:\$(echo \"\$win\" | cut -d: -f1) -F \"    └─ #{pane_index}: #{pane_current_command}#{?pane_active, (active),}\"; \
    done' --preview-window=right:66% | \
  xargs -r -I{} tmux switch-client -t {}"
set -g popup-style "bg=#282a36,fg=#f8f8f2"
set -g popup-border-style "fg=#bd93f9"

unbind-key Left
bind -n M-h select-pane -L
unbind-key Down
bind -n M-j select-pane -D
unbind-key Up
bind -n M-k select-pane -U
unbind-key Right
bind -n M-l select-pane -R

# used in vim
unbind-key C-Left
unbind-key C-Down
unbind-key C-Up
unbind-key C-Right

bind 1 select-window -t 1
bind 2 select-window -t 2
bind 3 select-window -t 3
bind 4 select-window -t 4
bind 5 select-window -t 5
bind 6 select-window -t 6
bind 7 select-window -t 7
bind 8 select-window -t 8
bind 9 select-window -t 9

set -g key-table root
bind -n M-w switch-client -T splits
bind -T splits Escape switch-client -T root
unbind '"'
bind -T splits - split-window -v -c "#{pane_current_path}"
unbind %
bind -T splits | split-window -h -c "#{pane_current_path}"
bind -T splits = select-layout tiled

set -g status-keys vi
set -g mode-keys vi
unbind [
bind Escape copy-mode
unbind-key -T copy-mode-vi Space
bind-key -T copy-mode-vi v send -X begin-selection
bind-key -T copy-mode-vi V send -X select-line
bind-key -T copy-mode-vi "C-v" send-keys -X rectangle-toggle \; send -X begin-selection
unbind-key -T copy-mode-vi Enter
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel
unbind-key -T copy-mode-vi C-d
bind-key -T copy-mode-vi M-d send-keys -X halfpage-down
unbind-key -T copy-mode-vi C-u
bind-key -T copy-mode-vi M-u send-keys -X halfpage-up
unbind-key -T copy-mode-vi C-f
bind-key -T copy-mode-vi M-f send-keys -X page-down
unbind-key -T copy-mode-vi C-b
bind-key -T copy-mode-vi M-b send-keys -X page-up
bind-key -T copy-mode-vi Escape send -X cancel
bind p paste-buffer
set -g mode-style "bg=#44475a,fg=#f8f8f2"
set -g copy-mode-match-style "bg=#f1fa8c,fg=#282a36"
set -g copy-mode-current-match-style "bg=#ffb86c,fg=#282a36"

set-option -g status-left "#{tmux_mode_indicator}"
set-option -g status-right "#[fg=#282a36,bg=#f1fa8c]#{?#{pane_ssh_connected}, #{username}@#{hostname} ,}#[bg=#f8f8f2,fg=#282a36] #S "
set-option -g status-style "bg=#424450,fg=#f8f8f2"

set-option -g window-status-format "#[fg=#6272a4,bg=#424450] #I #{?#{window_activity_flag},#[fg=#ff5555],#[fg=#6272a4]}#W #{?#{==:#{s/[Z#]//g:window_flags},-},#[fg=#bd93f9]-,#{?#{window_flags},#[fg=#bd93f9]#{s/[Z#]//g:window_flags},}}"
set-option -g window-status-current-format "#[fg=#f8f8f2,bg=#6272a4,bold] #I #W #{?#{window_zoomed_flag},#[fg=#bd93f9]■,#{?#{>:#{window_panes},1},#[fg=#bd93f9]+,#[fg=#bd93f9]*}#{?#{&&:#{window_flags},#{!=:#{window_flags},*}},#[fg=#bd93f9]#{window_flags},}} "
set-window-option -g monitor-activity on
set-option -g window-status-activity-style none

set -g cursor-colour "#ffffff"

set -g message-style "bg=#44475a,fg=#f8f8f2"
set -g message-command-style "bg=#44475a,fg=#8be9fd"

set -g clock-mode-colour "#8be9fd"
set -g clock-mode-style 24

set -g @plugin "tmux-plugins/tpm"
set -g @plugin "tmux-plugins/tmux-sensible"

set -g @plugin "tmux-plugins/tmux-resurrect"
set -g @resurrect-save 'S'
set -g @resurrect-restore 'L'
set -g @plugin "tmux-plugins/tmux-continuum"

set -g @plugin "MunifTanjim/tmux-mode-indicator"
set -g @mode_indicator_empty_mode_style "bg=white,fg=black"
set -g @mode_indicator_copy_mode_style "bg=dark_gray,fg=green"
set -g @plugin "soyuka/tmux-current-pane-hostname"

set -g @plugin 'Morantron/tmux-fingers'
set -g @fingers-key /
set -g @plugin 'roosta/tmux-fuzzback'
set -g @fuzzback-popup 1
set -g @fuzzback-popup-size '90%'

set -g @plugin 'lost-melody/tmux-command-palette'
set -g @cmdpalette-tables 'prefix,copy-mode-vi'
set -g @cmdpalette-key-prefix 'prefix Space'
set -g @cmdpalette-key-copy-mode-vi 'copy-mode-vi Space'

run "~/.tmux/plugins/tpm/tpm"
